---
title: "IM_RIGHT"
author: "Zhang Yiming"
date: "6/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(Seurat)
library(dplyr)
library(openxlsx)
library(ComplexHeatmap)
library(ggpubr)
library(stringr)
library(wesanderson)


gg_color_hue <- function(n) {
    hues = seq(15, 375, length = n + 1)
    hcl(h = hues, l = 65, c = 100)[1:n]
}


### extract temp information
stage_colors = c(
    "Normal"="#73BDFF", 
    "Benign"="#3E6596", 
    "CPI"="#C5000B", 
    "I"="#EC7A21", 
    "II"="#D73F47", 
    "III"="#65A9A3", 
    "IV"="#4A933E",
    "ADC" = "#063373", 
    "LCC"="#FECC1B", 
    "SCC"="#A0C807", 
    "LELC"="#6A0019", 
    "LBT"="#0084D1",
    "Other"="#DA6906"
    )
disease_colors = c(
    "ADC" = "#063373", 
    "LCC"="#FECC1B", 
    "Normal"="#73BDFF", 
    "Other"="#DA6906", 
    "SCC"="#A0C807", 
    "LELC"="#6A0019", 
    "CPI"="#C5000B", 
    "LBT"="#0084D1"
    )
tissue_colors = c(
    "Bronichi"="#FB290F", 
    "Lymph node"="#488F17", 
    "Tumor"="#FC8210"
)
patient_colors = gg_color_hue(50)

```

---

### gene drug
```{r}
full.path <- function(path) {
    return(paste("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug", path, sep = "/"))
}
```

#### 读取相关信息
```{r}
ap2 <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/Alveolar_II.rds")

basal <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/Basal.rds")

meta <- read.xlsx(full.path("肺癌基因药物关系.xlsx"), sheet = 3)
```

#### 读取两种细胞的亚群差异基因
```{r}
ap2_clt = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/annotation_results_by_cluster.xlsx", rowNames = T)

basal_clt = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/annotation_results_by_cluster.xlsx", rowNames = T)
```

#### 读取TCGA的相关生存率信息
```{R}
luad = read.csv("/mnt/raid62/Lung_cancer_10x/TCGA/LUAD_survival.csv")
lusc = read.csv("/mnt/raid62/Lung_cancer_10x/TCGA/LUSC_survival.csv")
```


```{r fig.height=8, fig.width=12}
DotPlot(
    ap2, 
    genes.plot = intersect(rownames(ap2@raw.data), meta[, 1]),
    group.by = "res.0.6"
    )

DotPlot(
    basal, 
    genes.plot = intersect(rownames(basal@raw.data), meta[, 1]),
    group.by = "res.0.6"
    )
```

#### Feature plots，检查基因在不同亚群间的分布情况

APII
```{r fig.height=12, fig.width=16}
p = FeaturePlot(
    ap2, 
    features.plot = intersect(rownames(ap2@raw.data), meta$基因名),
    cols.use = c("grey", "blue"),
    do.return = T
)

p[[length(p) + 1]] <- DimPlot(ap2, reduction.use = "tsne", group.by = "res.0.6", do.label = T, no.legend = T, do.return = T)

cowplot::plot_grid(plotlist = p, ncol = 4)
```

Basal
```{r fig.height=12, fig.width=16}
p = FeaturePlot(
    basal, 
    features.plot = intersect(rownames(basal@raw.data), meta$基因名),
    cols.use = c("grey", "blue"),
    do.return = T
)

p[[length(p) + 1]] <- DimPlot(basal, reduction.use = "tsne", group.by = "res.0.6", do.label = T, no.legend = T, do.return = T)

cowplot::plot_grid(plotlist = p, ncol = 4)
```

#### 检查，这些基因是否为两种细胞的cluster特异基因
```{r}
ap2_clt[ap2_clt$avg_logFC > 0 & ap2_clt$p_val_adj < 0.05 & ap2_clt$gene %in% meta$基因名, ]
```

```{r}
basal_clt[basal_clt$avg_logFC > 0 & basal_clt$p_val_adj < 0.05 & basal_clt$gene %in% meta$基因名, ]
```


### 主要盯着G6PD（靶向药物）
- APII - 1和2
- Basal - 10

亚群的生存率比较
```{r fig.height=8, fig.width=8}
make_violin_compare <- function(tcga, cluster_marker, qval=0.05, logfc=0.3) {
    res = NULL
    cluster_marker = cluster_marker[cluster_marker$p_val_adj < qval & cluster_marker$avg_logFC > logfc, ]
    
    temp = merge(cluster_marker, tcga, by = "gene")
    
    data = temp[, c("ident", "high")]
    colnames(data) <- c("ident", "value")
    data$source = "Median survival days"
    
    temp = temp[, c("ident", "pvalue")]
    colnames(temp) <- c("ident", "value")
    temp$value <- -log10(temp$value)
    temp$source = "-log10(PValue)"
    
    data = rbind(data, temp)
    data$ident = factor(data$ident, levels = sort(unique(data$ident)))
    
    ggviolin(data, x = "ident", y = "value", add = "boxplot", fill="ident", xlab="", ylab="", add.params = list(fill = "white")) +
        facet_grid(source~., scales = "free_y") 
    # 
    # ggplot(data = data, aes(x = ident, y = value, color = ident)) +
    #     geom_violin() +
    #     facet_grid(source~., scales = "free_y") +
    #     labs(x="", y="")
    
}

make_violin_compare(luad, ap2_clt)
make_violin_compare(lusc, basal_clt)
```

### 含有一下基因的module的生存率分布情况
```{r}
modules <- read.xlsx("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/tmod_mfuzz_overlap_AUC_0.5_merged.xlsx", sheet = 2)

modules <- modules[modules$Cell_name %in% c("Basal_SCC", "Alveolar_II_ADC"), ]

module_genes = NULL
for(i in 1:nrow(modules)) {
    row = modules[i, ]
    
    genes = str_split(row["Genes"], "\\|")[[1]]
    temp = data.frame(
        ID = paste(row["Cell_name"], row["Stage"], row["Mfuzz_ID"], sep = "_"),
        genes = genes
    )
    temp$Drugable = FALSE
    
    if (length(intersect(genes, meta$基因名)) > 0) {
        
        temp$Drugable = TRUE
    }
    module_genes = rbind(module_genes, temp)
}
```

看一下这些module的基因生存率p值和事件与随机抽选基因的对比
```{r fig.height=8, fig.width=12}
make_violin_compare_by_module <- function(tcga, module) {

    temp = merge(module, tcga, by.x = "genes", by.y = "gene")
    
    data = temp[, c("ID", "high", "Drugable")]
    colnames(data)[2] <- c("value")
    data$source = "Median survival days"
    
    temp = temp[, c("ID", "pvalue", "Drugable")]
    colnames(temp)[2] <- c("value")
    temp$value = -log10(temp$value)
    temp$source = "-log10(PValue)"
    
    data = rbind(data, temp)
    data$ID = factor(data$ID, levels = sort(unique(data$ID)))
    
    ggviolin(data, x = "ID", y = "value", add = "boxplot", fill="Drugable", xlab="", ylab="", add.params = list(fill = "white")) +
        facet_grid(source~., scales = "free_y") +
        theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 1))
    
    # ggplot(data = data, aes(x = ID, y = value, color = Drugable)) +
    #     geom_violin() +
    #     facet_grid(source~., scales = "free_y") +
    #     labs(x="", y="") +
    #     theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 1))
    
}

make_violin_compare_by_module(luad, module_genes[str_detect(module_genes[, 1], "Alveolar"), ])
make_violin_compare_by_module(lusc, module_genes[!str_detect(module_genes[, 1], "Alveolar"), ])
```


#### 做以-log10(PValue)为x轴和median survival days为y轴，每个cluster排序后分布的点图
```{r fig.height=6, fig.width=12}
make_scatter_compare <- function(gene, object) {
    
    if(!gene %in% rownames(object@scale.data)) {
        return(NULL)
    }
    
    data = object@scale.data[gene, , drop = F]
    data = as.data.frame(t(data))

    data$cell = rownames(data)

    data$cluster = object@meta.data[data$cell, "res.0.6"]
    
    colnames(data) <- c("value", "cell", "cluster")
    
    mean_val <- as.data.frame(data %>% group_by(cluster) %>% mutate(m1 = mean(value), m2 = median(value)) %>% dplyr::select(cluster, m1, m2) %>% unique())
    
    # print(mean_val)
    
    data$cluster = factor(data$cluster, levels = mean_val$cluster[order(mean_val$m2, decreasing = T)])
    p <- ggplot(
        data=data, 
        aes(x=reorder(cell, value), y = value, color = cluster)
    ) + 
        geom_point() +
        facet_grid(.~cluster) +
        theme(axis.text.x = element_blank()) +
        labs(title = gene) +
        geom_hline(data = mean_val, aes(yintercept=m1, linetype="mean"), color = "red") +
        geom_hline(data = mean_val, aes(yintercept=m2, linetype="median"), color = "blue") +
        scale_linetype_manual(
            name = "",
            values = c(2, 2),
            guide = guide_legend(override.aes = list(color = c("blue", "red")))
        )
    
    return(p)
}
```


###### APII
```{R fig.height=6, fig.width=12}
for(i in meta$基因名) {
    p <- make_scatter_compare(i, ap2)
    print(p)
}
```


###### Basal
```{R fig.height=6, fig.width=12}
for(i in meta$基因名) {
    p <- make_scatter_compare(i, basal)
    print(p)
}
```


---

### 做一下vlnplot，检查药物相关基因的表达量分布情况
```{r fig.height=12, fig.width=18}
VlnPlot(ap2, features.plot = intersect(rownames(ap2@raw.data), meta$基因名), group.by = "res.0.6")
```

```{r fig.height=12, fig.width=18}
VlnPlot(basal, features.plot = intersect(rownames(basal@raw.data), meta$基因名), group.by = "res.0.6")
```

---
### tmod检查APII不同群的功能，Basal不同亚群的功能

```{r}
library(tmod)

msig <- tmodImportMSigDB("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/msigdb_v6.2.xml")
sel <- msig$MODULES$Category %in% c("H","C5","C2")

ap2_marker <- read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/annotation_results_by_cluster.xlsx", rowNames = T)

basal_marker <- read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/annotation_results_by_cluster.xlsx", rowNames = T)
```

Function to perform cerno, utest and ztest

APII ADC
```{r}

resU_ap2 = NULL
resZ_ap2 = NULL
resC_ap2 = NULL


for(i in unique(ap2_clt$ident)) {
    temp_xlsx = ap2_clt[ap2_clt$ident == i, ]
    temp = tmodUtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i
        resU_ap2 = rbind(resU_ap2, temp)
    }
    
    
    temp = tmodCERNOtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i

        resC_ap2 = rbind(resC_ap2, temp)
    }
    
    temp = tmodZtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i
        resZ_ap2 = rbind(resZ_ap2, temp)
    }
    
}

```


```{R}
resAll_ap2 <- list(
    CERNO=resC_ap2[resC_ap2$ident == 1, ],
    U=resU_ap2[resU_ap2$ident == 1, ], 
    Z=resZ_ap2[resZ_ap2$ident == 1, ]
    )

tmodPanelPlot(resAll_ap2, pval.thr = 0.05, pval.thr.lower = -Inf)
```

```{R}
resAll_ap2 <- list(
    CERNO=resC_ap2[resC_ap2$ident == 2, ],
    U=resU_ap2[resU_ap2$ident == 2, ], 
    Z=resZ_ap2[resZ_ap2$ident == 2, ]
    )

tmodPanelPlot(resAll_ap2, pval.thr = 0.05, pval.thr.lower = -Inf)
```


Basal SCC
```{r}

resU_basal = NULL
resZ_basal = NULL
resC_basal = NULL


for(i in unique(basal_clt$ident)) {
    temp_xlsx = basal_clt[basal_clt$ident == i, ]
    temp = tmodUtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i
        resU_basal = rbind(resU_basal, temp)
    }
    
    
    temp = tmodCERNOtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i

        resC_basal = rbind(resC_basal, temp)
    }
    
    temp = tmodZtest(unique(temp_xlsx[rev(order(temp_xlsx$avg_logFC)), "gene"]), mset=msig[sel], qval=Inf)

    if (!is.null(temp) && nrow(temp) > 0) {
        temp$ident = i
        resZ_basal = rbind(resZ_basal, temp)
    }
    
}

```

```{R fig.height=20, fig.width=24}

make_tmod_dotplot <- function(resC, resU, resZ, pval.thr = 0.05, pval.thr.lower = -Inf) {
    resAll_basal <- list(
        CERNO=resC, 
        U=resU,
        Z=resZ
    )

    tmodPanelPlot(resAll_basal, pval.thr = pval.thr, pval.thr.lower = pval.thr.lower)
}


make_tmod_dotplot(
    resC = resC_basal[resC_basal$ident == 10 & str_detect(resC_basal$Title, "^Go"), ],
    resU = resU_basal[resU_basal$ident == 10 & str_detect(resU_basal$Title, "^Go"), ],
    resZ = resZ_basal[resZ_basal$ident == 10 & str_detect(resZ_basal$Title, "^Go"), ]
)
```


```{r fig.height=12, fig.width=20}
make_tmod_dotplot(
    resC = resC_basal[resC_basal$ident == 10 & str_detect(resC_basal$Title, "^[^(Go)]"), ],
    resU = resU_basal[resU_basal$ident == 10 & str_detect(resU_basal$Title, "^[^(Go)]"), ],
    resZ = resZ_basal[resZ_basal$ident == 10 & str_detect(resZ_basal$Title, "^[^(Go)]"), ]
)
```

##### Save tmod results
```{r}
wb = createWorkbook()
addWorksheet(wb, "CERNO")
writeData(wb, 1, resC_ap2)

addWorksheet(wb, "Utest")
writeData(wb, 2, resU_ap2)

addWorksheet(wb, "Ztest")
writeData(wb, 3, resZ_ap2)

saveWorkbook(wb, "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/APII_tmod.xlsx", overwrite = T)
```


```{r}
wb = createWorkbook()
addWorksheet(wb, "CERNO")
writeData(wb, 1, resC_basal)

addWorksheet(wb, "Utest")
writeData(wb, 2, resU_basal)

addWorksheet(wb, "Ztest")
writeData(wb, 3, resZ_basal)

saveWorkbook(wb, "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/Basal_tmod.xlsx", overwrite = T)
```


---
### make plots
```{r}

p = FeaturePlot(
    ap2, 
    features.plot = c("G6PD"),
    cols.use = c("grey", "blue"),
    do.return = T
)


p[[length(p) + 1]] <- VlnPlot(
    ap2, 
    features.plot = c("G6PD"), 
    group.by = "res.0.6",
    do.return = T,
    do.sort = T
)

p[[length(p) + 1]] <- DimPlot(
    ap2, 
    reduction.use = "tsne", 
    group.by = "res.0.6", 
    do.label = T,
    no.legend = T, 
    do.return = T,
    label.size = 8
)

p <- cowplot::plot_grid(plotlist = p, ncol = 3)

ggsave(
    "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/APII_G6PD.png",
    plot = p,
    width = 18,
    height = 6,
    dpi = 600,
    units = "in"
)
```

```{r}

p = FeaturePlot(
    basal, 
    features.plot = c("G6PD"),
    cols.use = c("grey", "blue"),
    do.return = T
)


p[[length(p) + 1]] <- VlnPlot(
    basal, 
    features.plot = c("G6PD"), 
    group.by = "res.0.6",
    do.return = T,
    do.sort = T
)

p[[length(p) + 1]] <- DimPlot(
    basal, 
    reduction.use = "tsne", 
    group.by = "res.0.6", 
    do.label = T,
    no.legend = T, 
    do.return = T,
    label.size = 8
)

p <- cowplot::plot_grid(plotlist = p, ncol = 3)

ggsave(
    "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/Basal_G6PD.png",
    plot = p,
    width = 18,
    height = 6,
    dpi = 600,
    units = "in"
)

```

---

### 做clusterProfiler style dotplot of top10 tmod results

```{r fig.height=12, fig.width=36}
make_tmod_cp_style_dotplot <- function(resC, resU, resZ, topn=10, auc = 0.5, ident = NULL) {
    data = NULL

    if (!is.null(ident)) {
        resC = resC[resC$ident == ident, ]
        resU = resU[resU$ident == ident, ]
        resZ = resZ[resZ$ident == ident, ]
    }
    
    resC = resC[resC$AUC > auc, ]
    resU = resU[resU$AUC > auc, ]
    resZ = resZ[resZ$AUC > auc, ]
    
#     print(resC %>% top_n(10, wt=P.Value))
    # temp = as.data.frame(resC %>% arrange(P.Value) %>% select(Title, N1, AUC, P.Value) %>% head(topn))
    temp = as.data.frame(resC %>% top_n(-topn, P.Value) %>% select(Title, N1, AUC, P.Value))
    
    if(nrow(temp) > 0) {
         # print(temp)
         temp$ident = "CERNO"
         data = rbind(data, temp)
    
    }
    
    temp = NULL
    # temp = as.data.frame(resU %>% arrange(P.Value) %>% select(Title, N1, AUC, P.Value) %>% head(topn))
    temp = as.data.frame(resU %>% top_n(-topn, P.Value) %>% select(Title, N1, AUC, P.Value))
    # print(temp)
    if(!is.null(temp) && nrow(temp) > 0) {
         # print(temp)
         temp$ident = "Utest"
         data = rbind(data, temp)
    
    }
    
    temp = NULL
    # temp = as.data.frame(resZ %>% arrange(P.Value) %>% select(Title, N1, AUC, P.Value) %>% head(topn))
    temp = as.data.frame(resZ %>% top_n(-topn, P.Value) %>% select(Title, N1, AUC, P.Value))
    # print(temp)
    if(!is.null(temp) && nrow(temp) > 0) {
         # print(temp)
         temp$ident = "Ztest"
         data = rbind(data, temp)
    
    }
    data = na.omit(data)
    
    p <- ggplot(
        data = data,
        aes(x = AUC, y=reorder(Title, AUC), color = P.Value, size = N1)) +
        geom_point() +
        facet_grid(.~ident, scales = "free") +
        scale_color_gradientn(colors=rev(wes_palette("Zissou1", 100, type = "continuous"))) +
        labs(y="")
    return(p)
}
```


APII 2
```{R fig.height=12, fig.width=12}
p <- make_tmod_cp_style_dotplot(resC_ap2, resU = resU_ap2, resZ = resZ_ap2, ident = 1)
p
ggsave(
    "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/APII_tmod_1.png",
    plot = p,
    width = 12, height = 8,
    dpi = 600,
    units = "in"
)
```


APII 2
```{R fig.height=12, fig.width=12}
p <- make_tmod_cp_style_dotplot(resC_ap2, resU = resU_ap2, resZ = resZ_ap2, ident = 2)
p
    "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/APII_tmod_2.png",
    plot = p,
    width = 12,
    height = 8,
    dpi = 600,
    units = "in"
)
```


Basal 10
```{R fig.height=12, fig.width=12}
p <- make_tmod_cp_style_dotplot(resC_basal, resU = resU_basal, resZ = resZ_basal, ident = 10)

ggsave(
    "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/gene_drug/Basal_tmod_10.png",
    plot = p,
    width = 12, height = 8,
    dpi = 600,
    units = "in"
)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
