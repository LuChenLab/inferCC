---
title: "Test_scBio_with_metacell"
author: "Zhang Yiming"
date: "7/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(scBio)
library(Rtsne)
library(ggplot2)
```



> Cell type predition is only a side result in this algorithm but it can be done as well. 
In order to get a proper cell-type predictions, it is crutial to set the cell space to be as homogeneous as possible. 
**One option is to create the cell space based on genes which have the lowest variance across the cells (but small amount of zeros). **
**Otherwise, CPM will detect trajectories inside the cell types and the cell-type prediction will be the average across these trajectories.** 
Seperation between cell-types uppon the cell space is not important since CPM divide the cell space into small fragments, corresponding to the different cell types.


```{r}
bulk_luad <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/ADC.csv", row.names = 1)
bulk_lusc <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/SCC.csv", row.names = 1)
```

```{r}
meta <- read.csv("/mnt/raid62/Lung_cancer_10x/00_data_ingest/03_annotation_csv/20190506_meta.csv", row.names = 1)
```

```{r}
load("/mnt/raid62/Lung_cancer_10x/MetaCell/random_selected/metacell_random_selected_1/mat.metacell_random_selected_1.Rda")
scmat = object


load("/mnt/raid62/Lung_cancer_10x/MetaCell/random_selected/metacell_random_selected_1/mc.metacell_random_selected_1_mc_f.Rda")
mc = object

load("/mnt/raid62/Lung_cancer_10x/MetaCell/random_selected/metacell_random_selected_1/gstat.metacell_random_selected_1.Rda")
gstat = object

out_df = rbind(tapply(colSums(scmat@mat[, names(mc@mc)]), mc@mc, mean), table(mc@mc))
out_df = cbind(rep("", nrow(out_df)), out_df)


fp_max = apply(mc@mc_fp, 1, max)
fp_tot = gstat[intersect(rownames(mc@mc_fp), rownames(gstat)), "tot"]


f = fp_max > 0 & fp_tot > 0

lfp = round(log2(mc@mc_fp[f,]), 2)
colnames(lfp) <- paste0("M", colnames(lfp))

pca = prcomp(t(lfp), center = F, scale = F)
```


## do tsne
```{r fig.height=6, fig.width=20}
temp = as.data.frame(apply(pca$x, 2, sd))
colnames(temp) <- c("SD")
temp$PC = factor(rownames(temp), levels = rownames(temp))

ggplot(temp[1:100,], aes(x = PC, y = SD)) + geom_point() + theme(axis.text.x = element_text(angle = 90))
```

```{r}
tsne_coord = Rtsne(pca$x[, 1:10])
tsne_coord = tsne_coord$Y
rownames(tsne_coord) = colnames(lfp)
```

```{r}
run_cpm <- function(sc_mat, tsne, bulk, no_cores = 6) {

    genes = intersect(rownames(sc_mat), rownames(bulk))
    
    
    sc_mat = sc_mat[genes, ]
    bulk_mat = bulk[genes, ]

    if(ncol(sc_mat) > 50) {
        modelSize = 50
    } else {
        modelSize = floor(ncol(sc_mat) / 2)
    }
    
    print(dim(sc_mat))
    print(dim(bulk_mat))

    res = CPM(
        SCData = sc_mat, 
        SCLabels = colnames(sc_mat), 
        BulkData = bulk_mat, 
        cellSpace = as.matrix(tsne), 
        quantifyTypes = T, 
        # typeTransformation = T, 
        no_cores = no_cores,
        neighborhoodSize = 5
    ) 
    return(res)
}
```


```{r}
res_luad = run_cpm(lfp, tsne_coord, bulk_luad)

res_lusc = run_cpm(lfp, tsne_coord, bulk_lusc)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
