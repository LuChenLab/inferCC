---
title: "Test_decon_gene_module"
author: "Zhang Yiming"
date: "2019/6/19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(reshape2)
library(ggplot2)
library(dplyr)

library(openxlsx)
library(stringr)
library(cowplot)
library(doMC)

registerDoMC(20)
```


```{r}
load("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/Two_deconMeths_results.RData")

adc_cib <- list(
    "I"=ADC_BULK_I_afterCIB,
    "II"=ADC_BULK_II_afterCIB,
    "III"=ADC_BULK_III_afterCIB,
    "IV"=ADC_BULK_IV_afterCIB
)

adc_decon <- list(
    "I"=ADC_BULK_I_afterDecon,
    "II"=ADC_BULK_II_afterDecon,
    "III"=ADC_BULK_III_afterDecon,
    "IV"=ADC_BULK_IV_afterDecon
)


scc_cib <- list(
    "I"=SCC_BULK_I_afterCIB,
    "II"=SCC_BULK_II_afterCIB,
    "III"=SCC_BULK_III_afterCIB
)

scc_decon <- list(
    "I"=SCC_BULK_I_afterDecon,
    "II"=SCC_BULK_II_afterDecon,
    "III"=SCC_BULK_III_afterDecon
)
```

加载NC表达量
```{R}
ADC <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/ADC.csv", row.names = 1)
SCC <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/SCC.csv", row.names = 1)
```



从单一时期结果中取出最好的几个结果
```{R}
# :param top and score only take one
# :param score: default is 0, mean disabled
extract_top_n_matched_from_matrix <- function(mat, top=1, score = 0) {
    colnames(mat) <- sapply(colnames(mat), function(x) {
        return(str_split(x, "\\.")[[1]][1])
    })
    
    mat = melt(as.matrix(mat))
    
    if (score > 0) {
        mat = mat[mat$value > score, ]
    } else {
        mat <- as.data.frame(mat %>% filter(value > 0) %>% group_by(Var2) %>% top_n(top, wt = value))
    }
    
    colnames(mat) <- c("NC_sample", "Cell_name", "value")
    
    return(mat)
}
```

凑齐所有时期的最优解
```{r}
# :param stages: named list
extract_top_n_of_different_stage <- function(stages, top=1, score = 0) {
    res = NULL
    for(i in names(stages)) {
        temp = extract_top_n_matched_from_matrix(stages[[i]], top=top, score = score)
        
        temp$stage = i
        res = rbind(res, temp)
    }
    return(res)
}
```

做柱状图，大概对不同细胞的现状略有了解
```{R}
barplot_of_score <- function(ext) {
    ggplot(data = ext, aes(x = stage, y = value, color = stage)) + 
        geom_point() + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
        facet_wrap(.~Cell_name)
    
}
```

构建路径全长
```{r}
full.path <- function(path) {
    return(paste("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/", path, sep = "/"))
}
```


```{r}
find_rds <- function(path) {
    rds = list.files(path, pattern = "*.rds", full.names = T)
    # print(rds)
    for(i in rds) {
        if(str_detect(basename(i), pattern = "^[^(monocle3|slingshot|wgcna)]")) {
            return(i)
        }
    }
}
```


计算PCA，并且作图

作图部分
```{R}
# correlation between pc and stage, for single cell
make_cor_plots <- function(pcobj, object=NULL, n.pcs = 100, title = NULL) {
    
    stage_to_int = c(
        "I"=1,
        "II"=2,
        "III"=3,
        "IV"=4
    )
    n.pcs = min(n.pcs, ncol(pcobj$x))
    if(!is.null(object)) {
        stages = object@meta.data[rownames(pcobj$x), "Stage"]
    } else {
        stages = sapply(rownames(pcobj$x), function(x) {
            return(str_split(x, "_")[[1]][4])
        })
    }
    
    stages = sapply(stages, function(x){return(stage_to_int[[x]])})
    
    res = matrix(NA, ncol = 2, nrow = n.pcs)
    for (i in 1:n.pcs) {
        res[i, 1] = i
        res[i, 2] = cor(stages, pcobj$x[, i], method="spearman")
    }
    
    colnames(res) <- c("PC", "r")
    res = as.data.frame(res)

    res$PC = factor(res[, 1], levels = sort(unique(res[, 1])))
    
    # print(head(res))
    
    p <- ggplot(data = as.data.frame(res), aes(x = PC, y = r)) + 
        geom_point() + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
    
    if(!is.null(title)) {
        p = p + labs(title = title)
    }
    return (p)
}


# make dotplot of different pcs
make_pca_plots <- function(pcobj, object=NULL, n.pcs=50, ncol=4, dot.size=0.1, size = NULL) {
    
    n.pcs = min(n.pcs, ncol(pcobj$x))

    plist = list()
    for(i in 1:(n.pcs - 1)) {

        key1 = paste("PC", i, sep = "")
        key2 = paste("PC", i + 1, sep = "")
        
        temp = pcobj$x[, c(key1, key2), drop = F]
        temp = as.data.frame(temp)
        
        
        if(!is.null(object)){
             temp$Stage = as.character(object@meta.data[rownames(temp), "Stage"])
        } else {
            temp$Stage = sapply(rownames(pcobj$x), function(x) {
                return(str_split(x, "_")[[1]][4])
            })
        }

        if(!is.null(size)) {
            size = as.data.frame(size)
            temp$size = size[rownames(temp), 1]
            
            p <- eval(
                parse(
                    text=paste0("ggplot(data = temp, aes(x=", key1, ", y = ", key2, ", color = Stage, size = size))")
                )
            )
        
            plist[[length(plist) + 1]] = p + geom_point() + guides(colour = guide_legend(override.aes = list(size=5)))
        } else {

            p <- eval(
                parse(
                    text=paste0("ggplot(data = temp, aes(x=", key1, ", y = ", key2, ", color = Stage))")
                )
            )
        
            plist[[length(plist) + 1]] = p + geom_point(size=dot.size) + guides(colour = guide_legend(override.aes = list(size=5)))
        }


    }
    
    p <- cowplot::plot_grid(plotlist = plist, ncol = ncol)
    return(p)
}




# make violin plot for single cell
make_violin_plot <- function(pcobj, object=NULL, n.pcs = 1, ncol=2) {
    n.pcs = min(n.pcs, ncol(pcobj$x))
    
    temp = pcobj$x[, 1:n.pcs, drop = F]
    temp = melt(temp)
    
    if(!is.null(object)){
        temp$Stage = object@meta.data[temp$Var1, "Stage"]
    } else {
        temp$Stage = sapply(rownames(pcobj$x), function(x) {
            return(str_split(x, "_")[[1]][4])
        })
    }
    p <- ggplot(data = temp, aes(x = Stage, y = value, fill = Stage)) + 
        geom_violin() + 
        facet_wrap(Var2~., scales = "free_y", ncol = ncol) +
        stat_summary(fun.y=median, geom="point", size=2) +
        geom_boxplot(width=0.1, fill = "white")
    
    return(p)
}
```


单细胞部分
```{r}
make_pc_of_single_cell <- function(object, genes.use, n.pcs=100, n.pcs.violin=5, ncol=3, title = NULL) {
    temp = as.matrix(t(object@scale.data[genes.use, , drop= F]))
    pcobj <- prcomp(temp, scale. = F, center = F)
    
    p1 <- make_cor_plots(pcobj, object, n.pcs = n.pcs, title = title)

    p2 <- make_violin_plot(pcobj, object, n.pcs = n.pcs.violin, ncol=ncol)

    p3 <- make_pca_plots(pcobj = pcobj, object = object, n.pcs = n.pcs.violin, ncol = ncol)

    return(plot_grid(p1, p2, p3, ncol = 1, rel_heights = c(0.5, 1, 1)))

}
```


Bulk部分
```{r}
make_pca_and_plots <- function(expr, genes.use, sample.use, n.pcs = 100, n.pcs.violin=5, ncol=3, title=NULL) {
    expr = as.matrix(expr[unique(as.character(genes.use)), unique(as.character(sample.use$NC_sample)), drop = F])
    expr = as.matrix(na.omit(expr))
    expr = as.matrix(t(expr))
    
    # remove non variance data
    expr = expr[, apply(expr, 2, var)!=0]

    pcobj <- prcomp(expr, scale. = T, center = T)
    
    size = sample.use[, "value", drop = F]
    rownames(size) = sample.use[, "NC_sample"]

    p1 <- make_cor_plots(pcobj = pcobj, n.pcs = n.pcs, title = title)
    p2 <- make_violin_plot(pcobj = pcobj, n.pcs = n.pcs.violin, ncol=ncol)
    p3 <- make_pca_plots(pcobj = pcobj, n.pcs = n.pcs.violin, ncol = ncol, dot.size = 3, size = size)
    
    return(plot_grid(p1, p2, p3, ncol = 1, rel_heights = c(0.5, 1, 1)))
    
}
```


从ADC CIB中提取所需的结果，选择最优解
```{r fig.height=4, fig.width=6}
ext_adc_cib = extract_top_n_of_different_stage(adc_cib)

barplot_of_score(ext_adc_cib)
```




#### Alveolar_II_ADC
```{R}
mfuzz <- read.xlsx(full.path("Alveolar_II_ADC/mfuzz_gene_module/results.xlsx"))
obj <- readRDS(full.path("Alveolar_II_ADC/Alveolar_II.rds"))
```

single cell check the mfuzz genes
```{r fig.height=16, fig.width=18}
make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene)
```

```{R  fig.height=18, fig.width=18}
make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = ext_adc_cib$NC_sample[ext_adc_cib$Cell_name == "Alveolar_II_ADC"])
```

---
 
### 每个单细胞mfuzz的结果，检查其能否区分不同时期的细胞
ADC single cell
```{r}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_single_cell"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(adc_cib, top = 1)

foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # print(p)
    ggsave(
        filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
        plot = p,
        width = 20,
        height = 20,
        dpi = 300,
        units = "in"
    )
}
```


SCC single cell
```{r}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_single_cell"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_cib, top = 1)

foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
# for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))

    ggsave(
        filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
        plot = p,
        width = 20,
        height = 20,
        dpi = 300,
        units = "in"
    )
}
```


---
### CIB批量做图

ADC CIB top 3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_BIC_top3"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(adc_cib, top = 3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = ext_adc_cib[ext_adc_cib$Cell_name == i, ], title = paste(i, "bulk", sep = " - "))
    # print(p)

    ggsave(
        filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
        plot = p,
        width = 20,
        height = 20,
        dpi = 300,
        units = "in"
    )
}
```


ADC CIB top 2
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_BIC_top2"
dir.create(output, showWarnings = F, recursive = T)


ext_adc_cib = extract_top_n_of_different_stage(adc_cib, top = 2)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {

for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))

    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )

    p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = ext_adc_cib[ext_adc_cib$Cell_name == i, ], title = paste(i, "bulk", sep = " - "))

    ggsave(
        filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
        plot = p,
        width = 20,
        height = 20,
        dpi = 300,
        units = "in"
    )
}
```


ADC CIB score >= 0.3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_BIC_score3"
dir.create(output, showWarnings = F, recursive = T)


ext_adc_cib = extract_top_n_of_different_stage(adc_cib, score = 0.3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))
    
    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))

    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = ext_adc_cib[ext_adc_cib$Cell_name == i, ]
    
    if(nrow(temp) < 2) {
        next
    }
    
    p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))

    ggsave(
        filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
        plot = p,
        width = 20,
        height = 20,
        dpi = 300,
        units = "in"
    )
}
```


----

SCC CIB top 3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_BIC_top3"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_cib, top = 3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])

    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```


SCC CIB top 2
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_BIC_top2"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_cib, top = 2)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])

    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```


SCC CIB score > 0.3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_BIC_score3"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_cib, score = 0.3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])

    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```


---
### Decon

ADC Decon top 3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_Decon_top3"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(adc_decon, top = 3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```



ADC Decon top 2
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_Decon_top2"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(adc_decon, top = 2)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
 for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```


SCC Decon top 3
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_Decon_top3"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_decon, top = 3)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```



SCC Decon top 2
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_Decon_top2"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_decon, top = 2)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
 for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```



ADC Decon score > 0.5
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/ADC_Decon_score5"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(adc_decon, score = 0.5)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
 for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=ADC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```


SCC Decon score > 0.5
```{R fig.height=6, fig.width=12}
output = "/mnt/raid62/Lung_cancer_10x/05_tmod_stage/Decon/SCC_Decon_score5"
dir.create(output, showWarnings = F, recursive = T)

ext_adc_cib = extract_top_n_of_different_stage(scc_decon, score = 0.5)

p = barplot_of_score(ext_adc_cib)
ggsave(
    filename = paste(output, "score.png", sep = "/"),
    plot = p,
    width = 12,
    height = 6,
    dpi = 600,
    units = "in"
)
print(p)

# foreach(i = as.character(unique(ext_adc_cib$Cell_name))) %dopar% {
 for (i in as.character(unique(ext_adc_cib$Cell_name))) {
    print(i)
    mfuzz <- read.xlsx(full.path(paste(i, "/mfuzz_gene_module/results.xlsx", sep = "")))
    obj <- readRDS(find_rds(full.path(i)))

    # p <- make_pc_of_single_cell(object = obj, genes.use = mfuzz$gene, title = paste(i, "single cell", sep = " - "))
    # # print(p)
    # ggsave(
    #     filename = paste(output, paste(i, "single_cell.png", sep = "_"), sep = "/"),
    #     plot = p,
    #     width = 20,
    #     height = 20,
    #     dpi = 300,
    #     units = "in"
    # )
    
    temp = as.data.frame(ext_adc_cib[ext_adc_cib$Cell_name == i, ])
    
    if(nrow(temp) >= 2) {
        p <- make_pca_and_plots(expr=SCC, genes.use = mfuzz$gene, sample.use = temp, title = paste(i, "bulk", sep = " - "))
        # print(p)
    
        ggsave(
            filename = paste(output, paste(i, "bulk.png", sep = "_"), sep = "/"),
            plot = p,
            width = 20,
            height = 20,
            dpi = 300,
            units = "in"
        )
    }
}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
