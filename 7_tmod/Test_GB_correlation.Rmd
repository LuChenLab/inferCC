---
title: "Test_correlation"
author: "Zhang Yiming"
date: "6/23/2019"
output: html_document
---
写在最前

1. 基础理论是WGCNA的简化版，之前自己也考虑过类似方案，盲猜不会优于mfuzz和wcgna
2. network构建这一套没什么问题，但是做BC这些东西略微有点扯，
    - 原本目的是用来找一堆基因中最重要的那一小撮。但是这个网络的r是筛选过的，基本上所有元素的bc值不会拉开距离。
    - 如果所想通过这个找比较重要的基因，那么具有相同表达模式的基因能反应什么生物学意义上的重要性呢？


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(openxlsx)
library(Seurat)
library(pheatmap)
library(reshape2)
library(ggplot2)
library(UpSetR)
```


## Basal SCC
```{r}
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/Basal.rds")

clt <- read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/annotation_results_by_stage.xlsx")
```


## scale data -> Z score
```{r}
mat = obj@scale.data[unique(clt$gene), ]
```

```{r}
pearson = cor(t(mat))

pheatmap(pearson, cluster_cols = F, cluster_rows = F)
```

```{r}
spearman = cor(t(mat), method = "spearman")

pheatmap(spearman, cluster_rows = F, cluster_cols = F)
```

## make density plots
```{r}
density_plot <- function(mat) {
    mat = melt(as.matrix(mat))
    mat = mat[mat[,1] != mat[,2],]
    ggplot(mat, aes(x=value)) + geom_density()
}
```

pearson
```{r}
density_plot(pearson)
```

spearman
```{r}
density_plot(spearman)
```

---

## Alveolar II

```{r}
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/Alveolar_II.rds")

clt <- read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/annotation_results_by_stage.xlsx")
```


## scale data -> Z score
```{r}
mat = obj@scale.data[unique(clt$gene[clt$p_val_adj < 0.05]), ]
```

```{r fig.height=36, fig.width=36}
pearson = cor(t(mat))

pheatmap(pearson, cluster_cols = F, cluster_rows = F)
```


pearson
```{r}
density_plot(pearson)
```


```{r fig.height=24, fig.width=24}
spearman = cor(t(mat), method = "spearman")

pheatmap(spearman, cluster_rows = T, cluster_cols = T)
```

spearman
```{r}
density_plot(spearman)
```

---
### 综合评估下不同mfuzz表达量的相关性，看最好的相关性有多少

```{R}
mfuzz <- read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/mfuzz_gene_module/results.xlsx")
```


```{r fig.height=12, fig.width=12}
mat = obj@scale.data[unique(mfuzz$gene[mfuzz$gene_module_id == 1]), ]

pearson = cor(t(mat), method = "pearson")

pheatmap(pearson, cluster_rows = T, cluster_cols = T)
```

```{r fig.height=12, fig.width=12}
mat = obj@scale.data[unique(mfuzz$gene[mfuzz$gene_module_id == 1]), ]

spearman = cor(t(mat), method = "spearman")

pheatmap(spearman, cluster_rows = T, cluster_cols = T)
```

```{r}
density_plot(spearman)
```

---
测试根据pearson相关性计算，选取前10%看一下，其与mfuzz结果的重合程度

```{r}
get_top_cor <- function(mat, top=0.01) {
    mat = melt(as.matrix(mat))
    
    mat = mat[mat[,1] != mat[,2],]
    
    mat$gene = apply(mat, 1, function(row) {
        temp = sort(c(row[1], row[2]))
        return(paste(temp[1], temp[2], sep = "|"))
    })
    
    mat = unique(mat[, c("gene", "value")])
    
    
    mat = mat[order(mat$value, decreasing = T),]
    mat = mat[1:round(top * nrow(mat)), ]
    mat$gene1 = sapply(mat$gene, function(x) {
        return(str_split(x, "\\|")[[1]][1])
    })
    mat$gene2 = sapply(mat$gene, function(x) {
        return(str_split(x, "\\|")[[1]][2])
    })
    
    return(mat[, c("gene1", "gene2", "value")])
}
```

```{r}
mat = obj@scale.data[unique(clt$gene[clt$p_val_adj < 0.05]), ]

pearson = cor(t(mat))

selected_mat <- get_top_cor(pearson, top = 0.01)
```


```{r}
length(unique(selected_mat$gene1, selected_mat$gene2))
```

BC
```{r}
g = graph_from_data_frame(selected_mat, directed = FALSE, vertices = NULL)


bc = betweenness(g, directed = F, normalized = T)


plot(density(bc))
```

```{r fig.height=8, fig.width=8}
DoHeatmap(obj, genes.use = names(bc[bc > 0.02]), group.by = "Stage", slim.col.label = T)
```

Degress
```{r}
d = degree(g)

plot(density(d))
```

```{r fig.height=8, fig.width=8}
DoHeatmap(obj, genes.use = names(d[d > 10]), group.by = "Stage", slim.col.label = T)
```

closeness
```{R}
cl = closeness(g)

plot(density(cl))
```


```{r fig.height=8, fig.width=8}
DoHeatmap(obj, genes.use = names(cl[cl < 0.0002]), group.by = "Stage", slim.col.label = T)
```

page rank
```{r}
pr = page_rank(g)

plot(density(pr$vector))
```

```{r fig.height=8, fig.width=8}
DoHeatmap(obj, genes.use = names(pr$vector[pr$vector > 0.005]), group.by = "Stage", slim.col.label = T)
```

---
### test randomforest
```{r fig.height=8, fig.width=8}
DoHeatmap(obj, genes.use = c(
    'GPC4', 'CYBA', 'ELF3', 'AZGP1', 'FKBP5', 'MUC1', 'TSC22D3', 'C4BPA',
       'MT2A', 'XIST', 'SCGB3A1', 'FAM84B', 'MBNL3', 'SPINK1', 'HLA-DQA2',
       'MT-RNR1', 'CHCHD2', 'HLA-DRB5', 'TAGLN2', 'POLR2J3-1', 'ERBB3',
       'CEACAM6', 'TFPI', 'SFTPC', 'QPRT', 'RNASE1', 'MT1E', 'SEC61G', 'EPS8',
       'CEACAM5', 'RPS4Y1', 'FABP5', 'MT-ND5', 'RPS19', 'MUC21', 'MT-ND4L',
       'AREG', 'SOX4', 'DRAM1', 'CTGF', 'DDIT4', 'EGR1', 'NET1', 'B3GNT7',
       'SCGB3A2', 'CD74', 'TRIB1', 'CP', 'RPS26', 'HMGN3', 'APLP2', 'PRR15L',
       'MYO6', 'MYLIP', 'PRSS8', 'C3', 'EFNA1', 'FOSB', 'BCAP31', 'JUNB',
       'S100A6', 'WNK1', 'PMAIP1'
    ),
    group.by = "Stage", slim.col.label = T
)
```

```{r fig.height=20, fig.width=8}
DoHeatmap(obj, genes.use = mfuzz$gene,
    group.by = "Stage", slim.col.label = T
)
```

---
NC PCA

```{r}
nc_luad <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/ADC.csv", row.names = 1)
nc_luad_col = data.frame(matrix(NA, ncol = 1, nrow=ncol(nc_luad)))
rownames(nc_luad_col) <- colnames(nc_luad)

nc_luad_col$Stage = sapply(colnames(nc_luad), function(x) {
    return(str_split(x, "_")[[1]][4])
})
nc_luad_col$Sex = sapply(colnames(nc_luad), function(x) {
    return(str_split(x, "_")[[1]][5])
})
nc_luad_col$Age = sapply(colnames(nc_luad), function(x) {
    return(as.numeric(str_split(x, "_")[[1]][6]))
})

nc_lusc <- read.csv("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/SCC.csv", row.names = 1)
nc_lusc_col = data.frame(matrix(NA, ncol = 1, nrow=ncol(nc_lusc)))
rownames(nc_lusc_col) <- colnames(nc_lusc)

nc_lusc_col$Stage = sapply(colnames(nc_lusc), function(x) {
    return(str_split(x, "_")[[1]][4])
})
nc_lusc_col$Sex = sapply(colnames(nc_lusc), function(x) {
    return(str_split(x, "_")[[1]][5])
})
nc_lusc_col$Age = sapply(colnames(nc_lusc), function(x) {
    return(as.numeric(str_split(x, "_")[[1]][6]))
})
```


LUAD and plot PCs by Stage
```{r fig.height=18, fig.width=24}
library(ggfortify)


pca_luad <- prcomp(t(nc_luad)[, apply(t(nc_luad), 2, var) > 0], scale. = T, center = T)

plist = list()
for(i in 1:(min(ncol(pca_luad$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_luad, data=nc_luad_col, colour = "Stage", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

plot by sex
```{r fig.height=18, fig.width=24}
plist = list()
for(i in 1:(min(ncol(pca_luad$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_luad, data=nc_luad_col, colour = "Sex", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

LUSC and plot PCs by Stage
```{R fig.height=18, fig.width=24}
pca_lusc <- prcomp(t(nc_lusc)[, apply(t(nc_lusc), 2, var) > 0], scale. = T, center = T)

plist = list()
for(i in 1:(min(ncol(pca_luad$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_lusc, data=nc_lusc_col, colour = "Stage")
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

plot by sex
```{r fig.height=18, fig.width=24}
plist = list()
for(i in 1:(min(ncol(pca_lusc$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_lusc, data=nc_lusc_col, colour = "Sex", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```


### Test all NC data
```{r}
nc <- read.xlsx("/mnt/raid62/Lung_cancer_10x/05_tmod_stage/SYSU/CHOICE_Study_Tumor_Adjacent_RNA-seq_Data.xlsx", rowNames = T)


nc_col = data.frame(matrix(NA, ncol = 1, nrow=ncol(nc)))
rownames(nc_col) <- colnames(nc)

nc_col$Disease = sapply(colnames(nc), function(x) {
    return(str_split(x, "_")[[1]][2])
})
nc_col$Stage = sapply(colnames(nc), function(x) {
    return(str_split(x, "_")[[1]][4])
})
nc_col$Sex = sapply(colnames(nc), function(x) {
    return(str_split(x, "_")[[1]][5])
})
nc_col$Age = sapply(colnames(nc), function(x) {
    return(as.numeric(str_split(x, "_")[[1]][6]))
})
nc_col$Disease_Stage = paste(nc_col$Disease, nc_col$Stage, sep = "-")
```

```{r fig.height=18, fig.width=24}
pca_nc <- prcomp(t(nc)[, apply(t(nc), 2, var) > 0], scale. = T, center = T)

plist = list()
for(i in 1:(min(ncol(pca_nc$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_nc, data=nc_col, colour = "Disease", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)


plist = list()
for(i in 1:(min(ncol(pca_nc$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_nc, data=nc_col, colour = "Stage", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```


### Test TCGA data
```{r}
tcga_luad <- read.csv("/mnt/raid62/Lung_cancer_10x/TCGA/LUAD_raw_expresion.csv")
tcga_luad_cli <- readRDS("/mnt/raid62/Lung_cancer_10x/TCGA/LUAD_clinical.rds")

test = readRDS("/mnt/raid62/Lung_cancer_10x/TCGA/LUAD.rds")


STAGES = c(
    "not reported"="Not reported",
    "stage i"="I",
    "stage ia"="I",
    "stage ib"="I",
    "stage ii"="II",
    "stage iia"="II",
    "stage iib"="II",
    "stage iii"="III",
    "stage iiia"="III",
    "stage iiib"="III",
    "stage iv"="IV"
)

raw = assay(test, "raw_count")
scale = assay(test, "scaled_estimate")
clinical = as.data.frame(colData(test))
clinical$Stage = sapply(clinical$tumor_stage, function(x) {
    return(STAGES[[x]])
})

```


```{R fig.height=18, fig.width=24}
pca_luad <- prcomp(t(raw)[, apply(t(raw), 2, var) > 0], scale. = T, center = T)
plist = list()
for(i in 1:(min(ncol(pca_luad$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_luad, data=clinical, colour = "Stage", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```


```{r fig.height=18, fig.width=24}
pca_luad <- prcomp(t(scale)[, apply(t(scale), 2, var) > 0], scale. = F, center = F)

plist = list()
for(i in 1:(min(ncol(pca_luad$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_luad, data=clinical, colour = "Stage", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```

## LUSC

```{r}
tcga_lusc = readRDS("/mnt/raid62/Lung_cancer_10x/TCGA/LUSC.rds")

# scale = assay(tcga_lusc, "scaled_estimate")
clinical = as.data.frame(colData(tcga_lusc))
clinical$Stage = sapply(clinical$tumor_stage, function(x) {
    return(STAGES[[x]])
})
```


```{R fig.height=18, fig.width=24}
pca_lusc <- prcomp(t(assay(tcga_lusc, "raw_count"))[, apply(t(assay(tcga_lusc, "raw_count")), 2, var) > 0], scale. = T, center = T)
plist = list()
for(i in 1:(min(ncol(pca_lusc$x), 10) - 1)) {
    plist[[i]] <- autoplot(pca_lusc, data=clinical, colour = "Stage", x=i, y=i + 1)
}

cowplot::plot_grid(plotlist = plist, ncol = 4)
```




----

## Test BigScale2
```

```


###
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
