---
title: "Test_raw_counts_radar"
author: "Zhang Yiming"
date: "2019/6/19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(openxlsx)
library(fmsb)
library(reshape2)
library(dplyr)
library(wesanderson)
```


```{r}
make_radar_plot_of_mfuzz <- function(object, mfuzz, scale=T) {
    if (scale) {
        expr = object@scale.data[unique(mfuzz$gene), ]
    } else {
        expr = log2(object@raw.data[unique(mfuzz$gene), ] + 1)
    }
    
    expr <- melt(as.matrix(expr))
    
    expr = merge(expr, mfuzz, by.x = "Var1", by.y = "gene")
    expr$Stage = object@meta.data[expr$Var2, "Stage"]
    expr$Patient = object@meta.data[expr$Var2, "PatientID"]
    expr <- as.data.frame(expr %>% group_by(Stage, Patient, gene_module_id) %>% mutate(m = mean(value)))
    
    for(i in sort(unique(expr$Stage))) {
        temp = unique(expr[expr$Stage == i, c("gene_module_id", "Patient", "m")])
        temp$gene_module_id = sapply(temp$gene_module_id, function(x){paste(x, i, sep = ".")})
        
        temp = dcast(temp, Patient~gene_module_id, value.var = "m")
        
        rownames(temp) <- temp$Patient
        temp <- temp[, !colnames(temp) %in% c("Patient")]

        max_ = max(temp[!is.na(temp)])
        min_ = min(temp[!is.na(temp)])
    
        # add min, max and sort matrix by stage
        temp <- rbind(
            rep(ceiling(max_), ncol(temp)),
            rep(floor(min_), ncol(temp)),
            temp
        )
        # temp = temp[, sort_by_stage(colnames(temp))]
    
        par(
            mfrow=c(1, 2),
            bty='n',
            oma = c(0.5,0.5,0,0) + 0.1,
            mar = c(1,0,0,1) + 0.1
        )
    
        legend_labels = rownames(temp)
        legend_labels = legend_labels[3: length(legend_labels)]
        colors_border = wes_palette("Zissou1", length(legend_labels), type = "continuous")
    
        radarchart(temp, axistype=1,
                   #custom polygon
                   pcol=colors_border, # pfcol=colors_in, plwd=4 , plty=1,
                   #custom the grid
                   cglcol="grey", cglty=1, axislabcol="grey",
                   caxislabels=seq(temp[2, 1], temp[1, 1], (temp[1, 1] - temp[2, 1]) / 5), cglwd=0.8,
                   #custom labels
                   vlcex=0.8
        )
        plot(0, col="white", cex=0, axes=F, ann=FALSE)
    
        legend(
            "left",
            legend = legend_labels,
            bty = "n", pch=20 ,
            col=colors_border ,
            text.col = "grey",
            cex=1.2,
            pt.cex=3,
            ncol = 2
        )
    }
    

}
```

## 直接采用mfuzz的结果，不采用mfuzz与tmod的overlap

### APII ADC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Alveolar_II_ADC/Alveolar_II.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### Basal SCC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Basal_SCC/Basal.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```



### Fibroblasts SCC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Fibroblasts_SCC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Fibroblasts_SCC/Fibroblasts.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### Fibroblasts ADC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Fibroblasts_ADC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Fibroblasts_ADC/Fibroblasts.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### CD4 ADC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/CD4_ADC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/CD4_ADC/CD4.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### CD4 SCC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/CD4_SCC//mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/CD4_SCC/CD4.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### Monocytes SCC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Monocytes_SCC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Monocytes_SCC/Monocytes.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```


### Monocytes ADC
```{R}
mfuzz = read.xlsx("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Monocytes_ADC/mfuzz_gene_module/results.xlsx")
obj <- readRDS("/mnt/raid62/Lung_cancer_10x/02_figures_each_cell/Monocytes_ADC/Monocytes.rds")
```

##### scale.data做radar plot
```{r echo=TRUE, fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz)
```

#### log2(raw counts  + 1) 做radar plot
```{R fig.height=6, fig.width=12}
make_radar_plot_of_mfuzz(object = obj, mfuzz=mfuzz, scale = F)
```